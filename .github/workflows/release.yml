env:
  CARGO_INCREMENTAL: '0'
  CARGO_NET_RETRY: '10'
  RUSTUP_MAX_RETRIES: '10'
jobs:
  build:
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@nightly
      with:
        targets: ${{ matrix.target }}
    - if: runner.os == 'Linux'
      name: Install mold
      uses: rui314/setup-mold@v1
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
    - name: Restore Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@main
    - name: Debug nix environment
      run: "echo \"=== NIX ENVIRONMENT DEBUG ===\"\necho \"\"\necho \"1. Which nix:\"\
        \nwhich nix || echo \"nix not found in PATH\"\necho \"\"\necho \"2. Nix version:\"\
        \nnix --version || echo \"failed\"\necho \"\"\necho \"3. Current PATH:\"\n\
        echo \"$PATH\" | tr ':' '\\n'\necho \"\"\necho \"4. LD_LIBRARY_PATH (before\
        \ nix-shell):\"\necho \"$LD_LIBRARY_PATH\"\necho \"\"\necho \"5. NIX_PROFILES:\"\
        \necho \"$NIX_PROFILES\"\necho \"\"\necho \"6. Package store paths:\"\necho\
        \ \"  mold: $(nix-build '<nixpkgs>' -A mold --no-out-link 2>/dev/null || echo\
        \ 'FAILED')\"\n\necho \"  pkg-config: $(nix-build '<nixpkgs>' -A pkg-config\
        \ --no-out-link 2>/dev/null || echo 'FAILED')\"\n\necho \"  openssl.out: $(nix-build\
        \ '<nixpkgs>' -A openssl.out --no-out-link 2>/dev/null || echo 'FAILED')\"\
        \n\necho \"  openssl.dev: $(nix-build '<nixpkgs>' -A openssl.dev --no-out-link\
        \ 2>/dev/null || echo 'FAILED')\"\n\necho \"\"\necho \"7. libssl.so locations\
        \ in nix store:\"\nfind /nix/store -name 'libssl.so*' 2>/dev/null | head -20\
        \ || echo \"none found\"\necho \"\"\necho \"8. libgbm.so locations in nix\
        \ store:\"\nfind /nix/store -name 'libgbm.so*' 2>/dev/null | head -20 || echo\
        \ \"none found\"\necho \"\"\necho \"9. Contents of openssl lib dir:\"\nls\
        \ -la \"$(nix-build '<nixpkgs>' -A openssl --no-out-link)/lib/\" 2>/dev/null\
        \ || echo \"failed\"\necho \"\"\necho \"10. Contents of openssl.dev lib dir:\"\
        \nls -la \"$(nix-build '<nixpkgs>' -A openssl.dev --no-out-link)/lib/\" 2>/dev/null\
        \ || echo \"failed\"\necho \"\"\necho \"11. ldd on a test binary (if exists):\"\
        \nif [ -f target/debug/todo ]; then\n  ldd target/debug/todo 2>&1 || echo\
        \ \"ldd failed\"\nelse\n  echo \"binary not built yet\"\nfi\necho \"\"\necho\
        \ \"12. System LD_LIBRARY_PATH search dirs:\"\ncat /etc/ld.so.conf 2>/dev/null\
        \ || echo \"no ld.so.conf\"\nldconfig -p 2>/dev/null | grep -E \"libssl|libgbm\"\
        \ | head -10 || echo \"ldconfig failed or no matches\"\necho \"\"\necho \"\
        13. Test nix-shell environment:\"\nnix-shell -p mold pkg-config openssl.out\
        \ openssl.dev --run 'echo \"Inside nix-shell LD_LIBRARY_PATH: $LD_LIBRARY_PATH\"\
        '\necho \"\"\necho \"14. Test nix-shell with manual LD_LIBRARY_PATH:\"\nnix-shell\
        \ -p mold pkg-config openssl.out openssl.dev --command 'export LD_LIBRARY_PATH=\"\
        $(nix-build \"<nixpkgs>\" -A openssl --no-out-link)/lib${LD_LIBRARY_PATH:+:}$LD_LIBRARY_PATH\"\
        \ && echo \"Manual LD_LIBRARY_PATH: $LD_LIBRARY_PATH\"'\necho \"\"\necho \"\
        15. Check if openssl lib has libssl.so.3:\"\nOPENSSL_PATH=$(nix-build '<nixpkgs>'\
        \ -A openssl --no-out-link 2>/dev/null)\nif [ -n \"$OPENSSL_PATH\" ]; then\n\
        \  ls -la \"$OPENSSL_PATH/lib/\" | grep ssl || echo \"no ssl libs in openssl\"\
        \nfi\necho \"\"\necho \"16. Check openssl.out (runtime output):\"\nnix-build\
        \ '<nixpkgs>' -A openssl.out --no-out-link 2>/dev/null && ls -la \"$(nix-build\
        \ '<nixpkgs>' -A openssl.out --no-out-link)/lib/\" | grep ssl || echo \"openssl.out\
        \ failed\"\necho \"\"\necho \"17. Env vars in nix-shell:\"\nnix-shell -p openssl\
        \ --run 'env | grep -E \"^(LD_|NIX_|PATH=)\" | sort'\necho \"\"\necho \"18.\
        \ Test subprocess inheritance:\"\nnix-shell -p mold pkg-config openssl.out\
        \ openssl.dev --command 'export LD_LIBRARY_PATH=\"$(nix-build \"<nixpkgs>\"\
        \ -A openssl --no-out-link)/lib:$LD_LIBRARY_PATH\" && bash -c \"echo subprocess\
        \ sees: \\$LD_LIBRARY_PATH\"'\necho \"\"\necho \"19. All openssl-related packages:\"\
        \nnix-env -qaP 'openssl.*' 2>/dev/null | head -20 || echo \"query failed\"\
        \necho \"\"\necho \"20. System libssl:\"\nldconfig -p 2>/dev/null | grep libssl\
        \ || echo \"no system libssl\"\necho \"\"\necho \"=== END DEBUG ===\"\n"
    - name: Remove dev cargo config
      run: rm -f .cargo/config.toml .cargo/config
    - name: Build release binary
      run: nix-shell -p mold pkg-config openssl.out openssl.dev --command "export
        LD_LIBRARY_PATH=\"\$(nix-build '<nixpkgs>' -A mold --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build '<nixpkgs>' -A pkg-config --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build '<nixpkgs>' -A openssl.out --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build '<nixpkgs>' -A openssl.dev --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && cargo build --release --target ${{ matrix.target }} ${{ matrix.cargo_flags
        }}"
    - if: runner.os != 'Windows'
      name: Package binary (unix)
      run: 'cd target/${{ matrix.target }}/release

        PNAME="${GITHUB_REPOSITORY##*/}"

        tar -czvf ../../../${PNAME}-${{ matrix.target }}.tar.gz $PNAME

        '
    - if: runner.os == 'Windows'
      name: Package binary (windows)
      run: 'cd target/${{ matrix.target }}/release

        $PNAME = $env:GITHUB_REPOSITORY.Split(''/'')[-1]

        Compress-Archive -Path "$PNAME.exe" -DestinationPath "../../../$PNAME-${{
        matrix.target }}.zip"

        '
      shell: pwsh
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: binary-${{ matrix.target }}
        path: '*.tar.gz

          *.zip'
    strategy:
      matrix:
        include:
        - cargo_flags: ''
          os: ubuntu-latest
          target: x86_64-unknown-linux-gnu
        - cargo_flags: ''
          os: macos-latest
          target: x86_64-apple-darwin
        - cargo_flags: ''
          os: macos-latest
          target: aarch64-apple-darwin
  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        path: artifacts
    - env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/*
name: Release
'on':
  push:
    tags:
    - v[0-9]+.*
  workflow_dispatch: {}
permissions:
  contents: write
